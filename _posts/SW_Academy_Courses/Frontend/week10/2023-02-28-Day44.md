---
categories: [SWACADEMY]
---

# Day 44

## strapië¥¼ ì´ìš©í•œ GraphQL ì„œë²„ ë§Œë“¤ê¸°

- strapi GraphQL ì„¤ì¹˜
- GraphQL ì„œë²„ì—ì„œ queryì™€ mutationìœ¼ë¡œ post CRUD, login í•´ë³´ê¸°

## Apollo Client ì†Œê°œ

### Apollo Clientë€?

- Reactì—ì„œ GraphQLì„ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ë‹¤.
- ìƒíƒœ ê´€ë¦¬, fetching, ìºì‹±, mutation, automatic UI updateë„ ì§€ì›í•´ì¤€ë‹¤.

[Apollo Client React ê³µì‹ ë¬¸ì„œ](https://www.apollographql.com/docs/react/get-started)

```js
// const client = ...

client
  .query({
    query: gql`
      query GetLocations {
        locations {
          id
          name
          description
          photo
        }
      }
    `,
  })
  .then((result) => console.log(result));
```

- gqlì€ template literal ë¬¸ë²•ì„ ì´ìš©í•´ì„œ ë‹¨ìˆœí•œ ë¬¸ìì—´ì„ graphql ë¬¸ë²•ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜ì´ë‹¤.

```js
import React from 'react';
import * as ReactDOM from 'react-dom/client';
import { ApolloClient, InMemoryCache, ApolloProvider } from '@apollo/client';
import App from './App';

const client = new ApolloClient({
  uri: 'https://flyby-router-demo.herokuapp.com/',
  cache: new InMemoryCache(),
});

// Supported in React 18+
const root = ReactDOM.createRoot(document.getElementById('root'));

root.render(
  <ApolloProvider client={client}>
    <App />
  </ApolloProvider>,
);
```

- `ApolloProvider`ë¥¼ Appì— ê°ì‹¸ì£¼ì–´ apollo clientë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```js
// DisplayLocations.js
// Import everything needed to use the `useQuery` hook
import { useQuery, gql } from '@apollo/client';

const GET_LOCATIONS = gql`
  query GetLocations {
    locations {
      id
      name
      description
      photo
    }
  }
`;

function DisplayLocations() {
  const { loading, error, data } = useQuery(GET_LOCATIONS);

  if (loading) return <p>Loading...</p>;
  if (error) return <p>Error : {error.message}</p>;

  return data.locations.map(({ id, name, description, photo }) => (
    <div key={id}>
      <h3>{name}</h3>
      <img width="400" height="250" alt="location-reference" src={`${photo}`} />
      <br />
      <b>About this location:</b>
      <p>{description}</p>
      <br />
    </div>
  ));
}
```

```js
// App.js
export default function App() {
  return (
    <div>
      <h2>My first Apollo app ğŸš€</h2>
      <br/>
      <DisplayLocations />
    </div>
  );
}
```

- `gql`ì„ ì´ìš©í•˜ì—¬ graphql ì¿¼ë¦¬ë¥¼ ë§Œë“¤ê³  `useQuery`ì— í•´ë‹¹ ë³€ìˆ˜ë¥¼ ëŒ€ì…í•¨ìœ¼ë¡œì¨ ê° ìƒíƒœì— ëŒ€í•œ ê°’ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.

### Queries

#### ê¸°ë³¸ ì‚¬ìš©ë²•

```js
import { gql, useQuery } from '@apollo/client';

const GET_DOGS = gql`
  query GetDogs {
    dogs {
      id
      breed
    }
  }
`;

function Dogs({ onDogSelected }) {
  const { loading, error, data } = useQuery(GET_DOGS);

  if (loading) return 'Loading...';
  if (error) return `Error! ${error.message}`;

  return (
    <select name='dog' onChange={onDogSelected}>
      {data.dogs.map((dog) => (
        <option key={dog.id} value={dog.breed}>
          {dog.breed}
        </option>
      ))}
    </select>
  );
}
```

#### Caching query result

- graphqlì€ ì²˜ìŒ ì„œë²„ì— queryë¥¼ ë‚ ë¦¬ë©´ í•´ë‹¹ queryê°€ ìë™ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ ë‹¨ì— cachingë˜ê¸° ë•Œë¬¸ì— êµ‰ì¥íˆ ë°ì´í„°ë¥¼ ë¹ ë¥´ê²Œ ë°›ì•„ì˜¬ ìˆ˜ ìˆë‹¤.

#### Polling

```js
function DogPhoto({ breed }) {
  const { loading, error, data } = useQuery(GET_DOG_PHOTO, {
    variables: { breed },
    pollInterval: 500,
  });

  if (loading) return null;
  if (error) return `Error! ${error}`;

  return (
    <img src={data.dog.displayImage} style={{ height: 100, width: 100 }} />
  );
}
```

- `useQuery`ì— optionê°’ìœ¼ë¡œ `pollInterval`ì„ ì„¤ì •í•˜ë©´ 0.5ì´ˆë§ˆë‹¤ ê°’ì„ ê°±ì‹ í•œë‹¤.
- `pollInterval`ì´ 0ì´ë©´ ê°’ì„ ê°±ì‹ í•˜ì§€ ì•ŠëŠ”ë‹¤.

#### Refetching 

```js
function DogPhoto({ breed }) {
  const { loading, error, data, refetch } = useQuery(GET_DOG_PHOTO, {
    variables: { breed },
  });

  if (loading) return null;
  if (error) return `Error! ${error}`;

  return (
    <div>
      <img src={data.dog.displayImage} style={{ height: 100, width: 100 }} />
      <button onClick={() => refetch({ breed: 'new_dog_breed' })}>
        Refetch new breed!
      </button>
    </div>
  );
}

<button
  onClick={() =>
    refetch({
      breed: 'dalmatian', // Always refetches a dalmatian instead of original breed
    })
  }
>
  Refetch!
</button>
```

- ìœ„ ì½”ë“œì²˜ëŸ¼ refetchí•¨ìˆ˜ë¥¼ ì´ìš©í•˜ì—¬ ì–´ë–¤ íŠ¹ì • ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œë§ˆë‹¤ ë°ì´í„°ë¥¼ fetchí•  ìˆ˜ ìˆë‹¤. ì´ë•Œ ì¸ìë¥¼ ë‹¤ë¥´ê²Œ í•´ì„œ fetchí•  ìˆ˜ë„ ìˆë‹¤.

#### Loading status í™•ì¸

```js
import { NetworkStatus } from '@apollo/client';

function DogPhoto({ breed }) {
  const { loading, error, data, refetch, networkStatus } = useQuery(
    GET_DOG_PHOTO,
    {
      variables: { breed },
      notifyOnNetworkStatusChange: true,
    }
  );

  if (networkStatus === NetworkStatus.refetch) return 'Refetching!';
  if (loading) return null;
  if (error) return `Error! ${error}`;

  return (
    <div>
      <img src={data.dog.displayImage} style={{ height: 100, width: 100 }} />
      <button onClick={() => refetch({ breed: 'new_dog_breed' })}>
        Refetch!
      </button>
    </div>
  );
}
```

- refetchingí•  ë•Œ ë¡œë”©ì´ ì•„ë‹ˆë¼ ë‹¤ë¥¸ ê±¸ ë³´ì—¬ì£¼ê³  ì‹¶ì„ ë•Œ networkStatus ë³€ìˆ˜ë¥¼ ì´ìš©í•  ìˆ˜ ìˆë‹¤.

#### useLazyQuery

- ì»´í¬ë„ŒíŠ¸ê°€ ìë™ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë°›ì§€ ì•Šê³  ì‚¬ìš©ì ì´ë²¤íŠ¸ë¥¼ ì´ìš©í•˜ì—¬ ë‚˜ì¤‘ì— ë°ì´í„°ë¥¼ fetchí•˜ê³  ì‹¶ë‹¤ë©´ `useLazyQuery()`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

#### Set a fetch policy

- ê¸°ë³¸ì ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œì„ í†µí•´ì„œ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ê³  ë‚´ë¶€ì ìœ¼ë¡œ ìºì‹±í•˜ê³  ë‹¤ìŒì— ë°›ì•„ì˜¬ ë•ŒëŠ” ìºì‹œëœ ë‚´ìš©ì„ ê°€ì ¸ì˜¤ëŠ” `cache-first` ì •ì±…ì„ ì‚¬ìš©í•˜ê³  ìˆë‹¤.
- ì´ëŸ° ì •ì±…ì„ ë‹¤ë¥¸ ì •ì±…ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥´ê²Œ ë™ì‘í•˜ë„ë¡ ì§€ì •í•´ì¤„ ìˆ˜ ìˆë‹¤.

### mutations

```js
import { gql, useMutation } from '@apollo/client';

// Define mutation
const INCREMENT_COUNTER = gql`
  # Increments a back-end counter and gets its resulting value
  mutation IncrementCounter {
    currentValue
  }
`;

function MyComponent() {
  // Pass mutation to useMutation
  const [mutateFunction, { data, loading, error }] = useMutation(INCREMENT_COUNTER);
}
```
- ìœ„ì™€ ê°™ì´ ì‹¤í–‰í•  í•¨ìˆ˜ì™€ gql ë³€ìˆ˜ë¥¼ ë„£ì–´ì£¼ë©´ `useLazyQuery`ì™€ ë¹„ìŠ·í•˜ê²Œ ì“¸ ìˆ˜ ìˆë‹¤.

## GraphQLì„ ì´ìš©í•œ Todo í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°

