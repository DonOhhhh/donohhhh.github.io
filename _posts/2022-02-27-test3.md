이번주는 별로 특별한 것이 없고 전 주차에 했었던 안드로이드 소스를 직접 빌드해보는 것을 이어서 할 것이다.

# 4. Download Android Platform Sources

저번주차에 특정 깃허브 주소에서 특정한 브랜치를 다운받아서 빌드해보려고 하였지만 default.xml이라는 파일의 부재로 다운로드 도중 오류가 발생했었다. 

그래서 default.xml을 따로 어디서 추가하는게 아닌 다른 명령어를 이용하여 안드로이드 전체 소스에서 특정 브랜치만을 다운받는 명령어를 사용하여 소스의 용량은 줄이되 정식버전을 사용하여 소스를 다운받는 과정에서의 오류는 잡도록 할 것이다.

```
sudo apt-get install git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig vim python2.7 -y
```

먼저 위 명령어를 통해 aosp 빌드에 필요한 packages를 다운받아준다.

```
sudo update-alternatives --install /usr/bin/python python /usr/bin/python2.7 1
sudo update-alternatives --install /usr/bin/python python /usr/bin/python3.6 2
sudo update-alternatives --config python
```

그리고 위 명령어를 통해 python 버전을 변경할 수 있도록 설정한다. 일단 지금은 python3 버전으로 유지한다.

```
curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
chmod a+x ~/repo
sudo mv ~/repo /usr/local/bin
```

그리고 curl 명령어를 이용하여 repo package를 다운받아 준다. 그냥 apt-get으로 repo package를 install하면 소스 용량을 줄일 수 있는 옵션들을 사용하질 못하기 때문에 특정 저장소에서 repo package를 따로 다운받아서 /usr/local/bin에 넣어준다.

```
git config --global user.name "aaaa"
git config --global user.email "aaaa@gmail.com"
```

그 후 git의 사용자 정보를 설정해준다.

```
sudo repo init -u https://android.googlesource.com/platform/manifest -b android-6.0.1_r81 -c --depth=1 --no-tags
sudo repo sync -q -c --no-tags
```

위 명령어들은 repo init과 sync 옵션 중에서 source 사이즈를 줄일 수 있는 옵션들을 최대한 많이 적용한 명령어이다. 

 repo init 옵션 

1) -c  옵션:  working branch 만 다운로드 하는 것으로 하나의 branch에서만 코드 작업을 하는 경우 유용하다. -c  옵션 사용하는 경우 branch 간 전환은 할 수 없다. 

2) --depth 옵션:  git log 로 확인한 가능한 history 개수를 제한한다. 예를 들어,  
   --depth=100 으로 설정했다면 git log로 100개 까지의 history 를 다운로드 한다.  소스를 처음 받는 경우 
   repo init 의 depth 옵션은 git clone 시 depth 옵션으로 전달된다. 

3) --no-tags 옵션:  tag 정보없이  소스를 다운로드 하는 것이다.  Working 소스에서 tag 가 전환이 필요 없는 경우 유용하다.

repo sync 옵션

1) -c 옵션: 현재 설정된 branch 의 소스만 다운로드 한다.

2) --no-tags 옵션:  Tag 정보 없이 소스를 다운로드 한다. 

3) -q 옵션: 진행중인 로그를 감춰준다.

repo sync 진행시 -j 명령어를 사용할 때는 사용자의 컴퓨터에서 쓰레드를 몇개나 쓸건지에 따라서 뒤에 숫자를 주면 된다. 하지만 이 옵션을 생략하면 알아서 쓰레드의 갯수를 배정하기 때문에 위 과정에서 생략하였다.

위 명령어들을 이용하여 정상적으로 repo sync까지 완료하였다.

[참고 사이트]

[[AOSP] Code Download 안드로이드 P 프리뷰 코드 다운로드 :: WOOHU](https://spoiler.tistory.com/107?category=662650)

[Android 소스 최적화 (100GB에서 65GB로 줄이기)](https://kibua20.tistory.com/51)

[AOSP 빌드 환경 설정](https://source.android.google.cn/setup/build/initializing?hl=ko#installing-required-packages-ubuntu-1804)

# 5. Build Platform Sources

이제 소스 다운로드가 끝났으니 빌드를 할 차례이다.

```
source build/envsetup.sh
```

먼저 위 명령어를 이용하여 빌드 환경을 조성해준다. 위 작업을 통해 m 명령어를 쓸 수 있게 되었다.

```
lunch
```

그리고 위 명령어를 입력해보면

![lunch.PNG](C:\Users\Don%20Oh\Desktop\images\1\lunch.PNG)

위 그림처럼 다양한 빌드 대상을 볼 수 있다. 여기서 가장 기본적인 1번을 선택한다.

![](C:\Users\Don%20Oh\AppData\Roaming\marktext\images\2022-02-26-04-29-29-image.png)

그러면 위와 같은 오류가 뜨는데 일단 넘어가자

```
m
```

그리고 m 명령어로 빌드를 시작해보면

![](C:\Users\Don%20Oh\AppData\Roaming\marktext\images\2022-02-26-04-30-35-image.png)

위 오류가 뜬다. 이는 현재 python 버전이 3인데 aosp 빌드할 때는 python 2버전을 쓰기 때문에 오류가 발생하는 것이다.

```
sudo update-alternatives --config python
```

위 명령어를 이용하여 python버전을 2.7로 바꿔준다.

![](C:\Users\Don%20Oh\AppData\Roaming\marktext\images\2022-02-26-04-31-50-image.png)

그리고 다시 m 명령어를 입력하면![](C:\Users\Don%20Oh\AppData\Roaming\marktext\images\2022-02-26-04-38-33-image.png)

Permission denied라는 오류가 뜬다.

![](C:\Users\Don%20Oh\AppData\Roaming\marktext\images\2022-02-26-04-40-33-image.png)

그래서 sudo로 m을 실행하면 명령어가 없다고 뜬다. 그래서 m과 동일한 기능을 하는 make 명령어를 다운받아서 실행시킬 것이다.

make 명령어는 실행하는 위치내에 makefile이 있으면 실행할 수 있다.

![](C:\Users\Don%20Oh\AppData\Roaming\marktext\images\2022-02-26-04-41-40-image.png)

```
sudo apt-get install make -y
```

위 명령어를 이용하여 make 명령어를 다운받은 뒤

```
sudo make
```

관리자 권한으로 make를 실행하면

![](C:\Users\Don%20Oh\AppData\Roaming\marktext\images\2022-02-26-04-44-05-image.png)

위와 같은 에러가 뜬다. 이때 가장 중요한 것이 **<u>java를 받으면 안되고 openjdk를 받아야 한다는 것이다.</u>** 이것때문에 고생좀 했다.

그래서 openjdk 7 버전을 받으려고 검색을 해본 결과 ubuntu 18.04에서는 openjdk 8버전부터 storage에서 지원하기 때문에 openjdk 7버전은 수동으로 압축파일을 받아서 풀고 환경변수 설정까지 해줘야 한다. 

```
sudo mkdir /usr/lib/jvm
cd /usr/lib/jvm
sudo wget https://download.java.net/openjdk/jdk7u75/ri/jdk_ri-7u75-b13-linux-x64-18_dec_2014.tar.gz
sudo tar zxvf jdk_ri-7u75-b13-linux-x64-18_dec_2014.tar.gz
export PATH="/usr/lib/jvm/java-se-7u75-ri/bin:$PATH"
```

먼저 위 명령어들로 /usr/lib/jvm 폴더를 만든 후 그 폴더에서 특정 링크로부터 openjdk 7버전을 가진 압축파일을 다운받은 후 압축을 풀고 PATH 환경변수에 해당 폴더의 경로를 추가해준다.

그리고 다시 AOSP 소스가 있는 폴더로 이동후 다음 명령어를 입력해준다.

```
sudo vi build/core/main.mk
```

만약 vi 명령어가 깔려있지 않은 경우 

```
sudo apt-get install vim -y
```

위 명령어를 사용하여 vim을 설치해준다.

![](C:\Users\Don%20Oh\AppData\Roaming\marktext\images\2022-02-26-04-52-56-image.png)

그러면 어떤 파일이 열리게 되는데 여기서 "153G"를 입력하면 

![](C:\Users\Don%20Oh\AppData\Roaming\marktext\images\2022-02-26-04-53-58-image.png)

위와 같은 화면이 나온다. 여기서 java를 openjdk로 바꿔준다.

![](C:\Users\Don%20Oh\AppData\Roaming\marktext\images\2022-02-26-04-54-44-image.png)

그리고 :wq!로 저장한 후 빠져나온다.

위 과정들을 모두 거쳤으면

```
m
```

다시 한번 m 명령어를 이용하여 build를 시도해준다.
